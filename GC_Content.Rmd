---
title: "GC_Content"
output: html_notebook
---

Friday 5th November 2021

In response to some reviewer comment, let's look at GC content of the genes involved. At this moment in time I do not have the non-canon list finalised so will only go so far as to do some data manipulation and look at the canon genes.

```{r}
gc <- read.table("input/GC/gc_Content.tsv", header = T, sep = "\t")
head(gc)
```
Add a all species average column

```{r}
gc <- gc[!duplicated(gc),]
rownames(gc) <- gc$Gene
gc$Gene <- NULL
head(gc)
```



```{r}
gc$GeneAverage <- rowMeans(gc[, c(2:12)])
head(gc)
```
Add the runs with averages of the branches included

Ie social corbiculates = the two Apis, two Bombus, Eufriesea, Meli and Calcarata

```{r}
gc$Solitary <- rowMeans(gc[, c("Dnov", "Hlab", "Mrot")])
gc$SocialCorb <- rowMeans(gc[, c("Bter", "Bimp", "Emex", "Mqua")])
gc$Social <- rowMeans(gc[, c("Bter", "Bimp", "Ccal", "Emex", "Mqua", "Lalb")])
gc$AdvancedEusocial <- rowMeans(gc[, c("Amel", "Aflo", "Mqua")])
gc$Apis <- rowMeans(gc[, c("Amel", "Aflo")])

head(gc)
```

```{r}
head(omega)
```
Just looking at dNdS and GC ....

```{r}
dNdS <- omega[,c(1:2)]
head(dNdS)
```
```{r}
gc$Gene <- rownames(gc)
gc.avg <- gc[, c("Gene", "AlnLength", "GeneAverage")]
rownames(gc.avg) <- NULL
head(gc.avg)
```

```{r}
dvg <- merge(dNdS, gc.avg, by = "Gene", all.x = T)
```

Lost some genes here but it'll only be the ones that failed to work in codeml

```{r}
head(dvg)
```
```{r}
library(ggplot2)

ggplot(dvg, aes(x = log(dN.dS), y = log(GeneAverage))) +
  geom_point()
```

Yeah, real correlated.

```{r}
p <- ggplot(dvg, aes(x = log(dN.dS), y = log(GeneAverage))) +
  geom_point(colour = "black") +
  stat_smooth(method = "lm",
        col = "#C42126",
        se = FALSE,
        size = 1)

p
```

If anything, higher evolutionary rate is associated with lower GC content ...

I can throw in the canon genes ...

```{r}
imm.nov <- read.table("ImmResources/ImmuneFunction_Nov2021.tsv",
                      header = T, sep = "\t")

imm.nov$Function[imm.nov$Function == "Recognition"] <- "Receptor"
summary(factor(imm.nov$Function))
```

Merge and remove too small sequences (less than 30 codons)

```{r}
dvg2 <- merge(dvg, imm.nov, by = "Gene", all.x = T)
dvg2$Codon <- dvg2$AlnLength/3
dvg2 <- dvg2[!dvg2$Codon < 30,]
tail(dvg2)
```

```{r}
p2 <- ggplot(dvg2, aes(x = log(dN.dS), y = log(GeneAverage))) +
  geom_point(aes(color = factor(Function))) +
  stat_smooth(method = "lm",
        col = "#C42126",
        se = FALSE,
        size = 1) +
  xlab("log dN/dS ratio") +
  ylab("log GC content")

p2
```

And just looking at GC

```{r}
p3 <- ggplot(dvg2, aes(x=Function, y=GeneAverage, fill = Function)) + 
  geom_boxplot()

p3
```
And omega ? 

```{r}
p3.2 <- ggplot(dvg2, aes(x=Function, y=dN.dS, fill = Function)) +
  geom_boxplot()

p3.2
```

At least we are seeing more evolutionary change in the receptors. Though I'd like to see what those outliers are ...

```{r}
dvg2[dvg2$dN.dS > 0.3,]
```


I'm gonna change the GC percentage to a proportion and see if that affects the scattergraph 

```{r}
dvg2$GCProp <- dvg2$GeneAverage/100

p4 <- ggplot(dvg2, aes(x = log(dN.dS), y = log(GCProp))) +
  geom_point(aes(color = factor(Function))) +
  stat_smooth(method = "lm",
        col = "#C42126",
        se = FALSE,
        size = 1) +
  xlab("log dN/dS ratio") +
  ylab("log GC content")

p4
```

Nope. Not in the slightest.

Pearson's coefficient

```{r}
attach(dvg2)
round(cor(cbind(dN.dS,AlnLength,GCProp)),2)
```

```{r}
pairs(~log(dN.dS)+log(AlnLength)+log(GCProp),
      gap = .5)
```

... Are they linear ?? So many datapoints.

```{r}
lm1 <- lm(dN.dS ~ GCProp, data = dvg2)
summary(lm1)
```

```{r}
lm2 <- lm(dN.dS ~ GCProp + AlnLength, data = dvg2)
summary(lm2)
```

```{r}
library("car")
vif(lm2)
```

Tolerance should be about 1. So these are fine.

```{r}
hist(resid(lm2),main='Histogram of residuals',xlab='Standardised Residuals',ylab='Frequency')
```
These are not normally distributed which breaks the assumption of normality.

And just for completion ...

```{r}
plot(lm2, which = 1)
```

Much bunching in the scatterplot. Not exactly spread out.

```{r}
lm3 <- lm(log(dN.dS) ~ log(GeneAverage) + log(AlnLength), data = dvg2)
summary(lm3)
```

Still significant relationship between GC and evolutionary rate however ...

```{r}
hist(resid(lm3),main='Histogram of residuals',xlab='Standardised Residuals',ylab='Frequency')
```
```{r}
qqnorm(resid(lm3))
qqline(resid(lm3))
```
```{r}
dvg2[dvg2$Gene == "LOC724292",]
```

I now have a preliminary list of non-canon genes to play with.


```{r}
dvg3 <- read.table("output/AlignmentInfo2_Nov2021.tsv",
                   header = T, sep = "\t")
head(dvg3)
```

```{r}
p2 <- ggplot(dvg3, aes(x = log(dN.dS), y = log(GeneAverage))) +
  geom_point(aes(color = factor(Function))) +
  stat_smooth(method = "lm",
        col = "#C42126",
        se = FALSE,
        size = 1) +
  xlab("log dN/dS ratio") +
  ylab("log GC content")

p2
```

```{r}
p3 <- ggplot(dvg3, aes(x=Function, y=GeneAverage, fill = Function)) + 
  geom_boxplot()

p3
```
And dN.dS ... 

```{r}
dvg3$Function <- factor(dvg3$Function, levels=c("Receptor", 
                                                "Signalling", "Effector",
                                                "Non-Canon", "NA"))

p3 <- ggplot(dvg3, aes(x=Function, y=dN.dS, fill = Function)) + 
  geom_boxplot()

p3
```

```{r}
png("Plots/PrelimdN.dS.png")
p3
dev.off
```

Hmm. I'm gonna have to look at some of these alignments that have high dNdS ....

```{r}
dvg3[dvg$dN.dS > 0.3,]
```



```{r}
highomega <- as.data.frame(dvg3$Gene[dvg3$dN.dS > 0.3])
write.table(highomega, "output/highomega.txt", col.names = F, row.names = F, quote = F)
```

So I went away and looked through those alignments and took out 3 for seeming to have shifted a reading frame or having a species where the protein is no longer predicted.

```{r}
remaln <- c("LOC727165", "LOC726460", "LOC102654160")
dvg3[dvg3$Gene %in% remaln,]
```

Plot again ...


```{r}
dvg4 <- dvg3[!dvg3$Gene %in% remaln,]

library("stringr")
dvg4$Function <- str_replace_na(dvg4$Function, replacement = "Background")
dvg4$Function[dvg4$Function == "Non-Canon"] <- "Non-Canon Immune"

head(dvg4)
```


```{r}
dvg4$Function <- factor(dvg4$Function, levels=c("Receptor", 
                                                "Signalling", "Effector",
                                                "Non-Canon Immune", "Background"))


p2 <- ggplot(dvg4, aes(x = log(dN.dS), y = log(GeneAverage))) +
  geom_point(aes(color = factor(Function), shape = factor(Function))) +
  scale_color_manual(values = c("Receptor" = "pink",
                                "Signalling"="orange",
                                "Effector"="skyblue",
                                "Non-Canon Immune"="green",
                                "Background"="gray")) +
  stat_smooth(method = "lm",
        col = "#C42126",
        se = FALSE,
        size = 1) +
  xlab("log dN/dS ratio") +
  ylab("log GC content")

p2
```

```{r}
dvg4$Immune <- ifelse(dvg4$Function == "Background", "0", "1")
dvg4$Class[dvg4$Function == "Background"] <- "Background"
dvg4$Class[dvg4$Function == "Non-Canon Immune"] <- "Non-Canon"
dvg4$Class <- str_replace_na(dvg4$Class, replacement = "Canon Immune")
head(dvg4, n= 40)
```


```{r}
p2 <- ggplot(dvg4, aes(x = log(dN.dS), y = log(GeneAverage))) +
  geom_point(aes(color = Class, alpha = Immune)) +
  scale_color_manual(values = c("#56B4E9",
                               "violet",
                               "#009E73",
                                "#F0E442",
                                "gray"), 
                     name = "Gene Class") +
  #scale_alpha_manual(values = c(0.25, 5), guide = "none") +
   geom_line(stat="smooth",method = "lm",
              size = .5,
              linetype ="dashed",
              alpha = 0.5) + 
        xlab("log dN/dS ratio") +
        ylab("log GC content")

p2
```

```{r}
p3 <- ggplot(dvg4, aes(x=Function, y=GeneAverage, fill = Class)) + 
  geom_boxplot() + 
  scale_fill_manual(values = c("#56B4E9",
                               "violet",
                               "#009E73",
                                "#F0E442",
                                "gray"),
                    name = "Gene Class")

p3
```
```{r}
dvg4$Class <- factor(dvg4$Class, levels=c("Canon Immune", 
                                                "Non-Canon", 
                                                "Background"))

p3.2 <- ggplot(dvg4) +
  geom_boxplot(aes(x=Function, y=dN.dS, fill = Class)) +
  scale_fill_manual(values = c("#009E73",
                               "violet",
                               "gray"), 
                    name = "Gene Class") +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  xlab("Gene Function") +
  ylab("dN/dS Ratio")
   
p3.2
```

Write up Table

```{r}
head(dvg4)
dvg5 <- dvg4[,c(1,5,9,2:4,6:8)]

head(dvg5)

write.table(dvg5, "Genome_Misc/AlnInfo_ImmFunc_Nov2021.tsv",
            col.names = T, row.names = T, quote = F, sep = "\t")
```

